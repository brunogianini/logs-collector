name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Build
        run: |
          echo "Compilando..."
          exit 1  # Simula erro

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Run tests
        run: |
          echo "Rodando testes..."
          exit 1  # Simula erro

  collect-logs:
    runs-on: ubuntu-latest
    needs: [build, test]
    if: ${{ failure() }}
    steps:
      - name: Fetch failed job logs and save to file
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          echo "Buscando jobs que falharam..."
  
          # Busca todos os jobs da run
          jobs_failed=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${REPO}/actions/runs/${RUN_ID}/jobs")
  
          # Extrai os IDs e nomes dos jobs que falharam
          jobs_failed_info=$(echo "$jobs_failed" | jq -r '.jobs[] | select(.conclusion=="failure") | "\(.id) \(.name)"')
  
          # Arquivo final de logs
          LOG_FILE="failed_jobs_logs.txt"
          echo "===== Logs dos jobs falhados =====" > $LOG_FILE
  
          # Itera sobre cada job_id e job_name
          while read -r job_id job_name; do
            echo "===== Job: $job_name (ID: $job_id) =====" >> $LOG_FILE
            
            curl -sL \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${REPO}/actions/jobs/${job_id}/logs" >> $LOG_FILE
            
            echo -e "\n===== Fim do job: $job_name =====\n" >> $LOG_FILE
          done <<< "$jobs_failed_info"
  
          echo "Todos os logs foram salvos em $LOG_FILE"
      
      - name: Lendo
        run: |
          cat failed_jobs_logs.txt

      - name: Upload logs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: failed-jobs-logs
          path: failed_jobs_logs.txt
