name: CI/CD com coleta de logs

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Step 1
        run: |
          echo "Build iniciado..."
          # Simulando falha
          exit 1

  test:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test Step 1
        run: |
          echo "Testando aplicação..."
          # Simulando sucesso
          echo "Tudo OK!"

  lint:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Lint
        run: |
          echo "Rodando lint..."
          # Simulando falha
          exit 1

  collect-logs:
    runs-on: ubuntu-latest
    needs: [build, test, lint]
    if: failure()
    steps:
      - name: Coletar e exibir logs completos dos jobs que falharam
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_ID: ${{ github.run_id }}
          REPO: ${{ github.repository }}
        run: |
          set -e
          echo "📥 Baixando logs do workflow $RUN_ID..."
          curl -sSL \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -o logs.zip \
            "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID/logs"

          echo "📦 Extraindo logs..."
          mkdir logs
          unzip -q logs.zip -d logs
          rm logs.zip

          echo "🔍 Detectando jobs que falharam..."
          curl -sSL \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID/jobs" \
            | jq -r '.jobs[] | select(.conclusion=="failure") | .name' > failed_jobs.txt

          if [ ! -s failed_jobs.txt ]; then
            echo "✅ Nenhum job falhou."
            exit 0
          fi

          echo "🧾 Jobs com falha:"
          cat failed_jobs.txt
          echo "═══════════════════════════════════════════════"

          echo "📜 Exibindo logs COMPLETOS dos jobs com falha..."
          for job in $(cat failed_jobs.txt); do
            # Nome do arquivo dentro do ZIP geralmente é "<job_name>.txt" com underscores no lugar de espaços
            file=$(find logs -type f -iname "$(echo "$job" | tr ' ' '_').txt" | head -n 1)
            if [ -z "$file" ]; then
              echo "⚠️  Não encontrei log para o job: $job"
              continue
            fi

            echo "═══════════════════════════════════════════════"
            echo "💥 LOG COMPLETO DO JOB: $job"
            echo "───────────────────────────────────────────────"
            cat "$file"
            echo
          done

          echo "═══════════════════════════════════════════════"
          echo "🏁 Fim dos logs de falhas"
